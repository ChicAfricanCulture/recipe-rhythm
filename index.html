<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recipe Rhythm</title>
  <style>
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #ffffff;
      color: #0f1720;
    }

    .wrap {
      height: 100%;
      width: min(520px, 100%);
      margin: 0 auto;
      display: flex;
      flex-direction: column;
    }

    .hud {
      padding: 10px 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(15, 23, 32, 0.08);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(6px);
    }
    .hud-left { display: grid; gap: 2px; }
    .title {
      font-weight: 1000;
      letter-spacing: 0.2px;
      font-size: 14px;
      line-height: 1.1;
    }
    .subtitle {
      font-size: 12px;
      opacity: 0.78;
      line-height: 1.2;
    }

    .hud-right {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      text-align: right;
      font-variant-numeric: tabular-nums;
      flex-wrap: wrap;
    }

    .pill {
      background: rgba(15, 23, 32, 0.06);
      border: 1px solid rgba(15, 23, 32, 0.10);
      padding: 7px 9px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      white-space: nowrap;
      user-select: none;
    }
    .pill strong { font-weight: 1000; }

    .pill-btn {
      border: 1px solid rgba(15, 23, 32, 0.10);
      background: rgba(15, 23, 32, 0.06);
      border-radius: 999px;
      padding: 7px 10px;
      font-weight: 1000;
      font-size: 12px;
      cursor: pointer;
      color: #0f1720;
      user-select: none;
    }
    .pill-btn:active { transform: translateY(1px); }
    .pill-btn:disabled { opacity: 0.45; cursor: not-allowed; }

    .stage {
      flex: 1 1 auto;
      min-height: 0;
      position: relative;
    }
    canvas {
      width: 100%;
      height: 100%;
      display: block;
      touch-action: manipulation;
    }

    /* Overlays never block clicks when hidden */
    .overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 12px;
      background: rgba(255,255,255,0.72);
      z-index: 30;
      pointer-events: none;
    }
    .overlay.show { display: flex; pointer-events: auto; }

    .card {
      width: min(520px, 100%);
      background: #ffffff;
      border: 1px solid rgba(15, 23, 32, 0.10);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.12);
    }
    .card h1 { margin: 0 0 8px; font-size: 18px; font-weight: 1000; }
    .card p  { margin: 0 0 12px; font-size: 13px; line-height: 1.45; opacity: 0.9; }
    .btnRow { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }

    button {
      border: none;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 900;
      font-size: 13px;
      cursor: pointer;
      background: #0f1720;
      color: #fff;
    }
    button:active { transform: translateY(1px); }

    @media (max-height: 650px) {
      .card { padding: 10px; }
      button { padding: 6px 8px; font-size: 12px; }
      .card h1 { font-size: 16px; }
      .card p  { font-size: 12px; }
    }

    .flash {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: rgba(231, 76, 60, 0.12);
      opacity: 0;
      transition: opacity 120ms ease;
      z-index: 5;
    }
    .flash.show { opacity: 1; }

    .banner {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #0f1720;
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 1000;
      font-size: 13px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.15);
      opacity: 0;
      transition: opacity 160ms ease;
      z-index: 10;
      max-width: calc(100% - 24px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      pointer-events: none;
    }
    .banner.show { opacity: 1; }

    .hint {
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 10px;
      font-size: 12px;
      opacity: 0.78;
      text-align: center;
      pointer-events: none;
      z-index: 2;
    }

    /* Rooster distraction */
    .rooster {
      position: absolute;
      left: 10px;
      bottom: 44px;
      z-index: 3;
      display: flex;
      gap: 8px;
      align-items: center;
      user-select: none;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15,23,32,0.06);
      border: 1px solid rgba(15,23,32,0.10);
      backdrop-filter: blur(6px);
    }
    .rooster .emoji {
      font-size: 18px;
      transform-origin: 50% 100%;
      animation: bob 1.6s ease-in-out infinite;
    }
    .rooster .txt { font-size: 12px; font-weight: 900; opacity: 0.85; }
    @keyframes bob {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
    }

    /* Unlock box styling */
    .unlockBox {
      display: none;
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,32,0.12);
      background: rgba(15,23,32,0.03);
    }
    .unlockTitle {
      font-weight: 1000;
      margin-bottom: 6px;
    }
    .unlockMeta {
      font-weight: 1000;
      margin-bottom: 8px;
      opacity: 0.92;
    }
    .unlockText {
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.45;
      opacity: 0.95;
    }
    .unlockBtns {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hud">
      <div class="hud-left">
        <div class="title">Recipe Rhythm</div>
        <div class="subtitle" id="hudSubtitle">Level 1</div>
      </div>
      <div class="hud-right">
        <div class="pill">‚è≥ <strong id="timeVal">‚Äî</strong></div>
        <div class="pill">üéØ Next: <strong id="nextVal">‚Äî</strong></div>
        <div class="pill">‚úÖ <strong id="stepVal">‚Äî</strong></div>
        <button class="pill-btn" id="hintBtn" type="button" disabled>
          Hint (<span id="hintCount">0</span>)
        </button>
      </div>
    </div>

    <div class="stage">
      <canvas id="c"></canvas>
      <div class="flash" id="flash"></div>
      <div class="banner" id="banner"></div>

      <div class="rooster" id="rooster" aria-label="Rooster distraction">
        <div class="emoji">üêì</div>
        <div class="txt">crow?</div>
      </div>

      <div class="overlay show" id="startOverlay">
        <div class="card">
          <h1>Tap the recipe in order.</h1>
          <p>
            You‚Äôll see the sequence briefly, then it disappears.<br/>
            Tap the floating ingredients in the correct order before time runs out.<br/><br/>
            You get <strong>2 hints</strong> per level. Each hint costs <strong>10 seconds</strong>.
          </p>
          <div class="btnRow">
            <button id="startBtn" type="button">Start Level 1</button>
          </div>
        </div>
      </div>

      <div class="overlay" id="endOverlay">
        <div class="card">
          <h1 id="endTitle">Done</h1>
          <p id="endText"></p>

          <div class="unlockBox" id="unlockBox">
            <div class="unlockTitle" id="unlockTitle">üéâ You unlocked a secret</div>
            <div class="unlockMeta" id="unlockMeta"></div>
            <div class="unlockText" id="unlockText"></div>
            <div class="unlockBtns">
              <button id="copyUnlockBtn" type="button">Copy Note</button>
            </div>
          </div>

          <div class="btnRow" style="margin-top: 12px;">
            <button id="replayBtn" type="button">Replay Level</button>
            <button id="nextBtn" type="button">Next Level</button>
          </div>
        </div>
      </div>

      <div class="hint" id="hint">You‚Äôll see the recipe once. Then it‚Äôs rhythm.</div>
    </div>
  </div>

<script>
(() => {
  /**********************
   * DOM
   **********************/
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  const hudSubtitle = document.getElementById("hudSubtitle");
  const timeVal = document.getElementById("timeVal");
  const nextVal = document.getElementById("nextVal");
  const stepVal = document.getElementById("stepVal");

  const startOverlay = document.getElementById("startOverlay");
  const endOverlay = document.getElementById("endOverlay");
  const endTitle = document.getElementById("endTitle");
  const endText = document.getElementById("endText");

  const flash = document.getElementById("flash");
  const banner = document.getElementById("banner");

  const startBtn = document.getElementById("startBtn");
  const replayBtn = document.getElementById("replayBtn");
  const nextBtn = document.getElementById("nextBtn");

  const hintBtn = document.getElementById("hintBtn");
  const hintCountEl = document.getElementById("hintCount");

  const rooster = document.getElementById("rooster");

  const unlockBox = document.getElementById("unlockBox");
  const unlockMeta = document.getElementById("unlockMeta");
  const unlockText = document.getElementById("unlockText");
  const copyUnlockBtn = document.getElementById("copyUnlockBtn");

  /**********************
   * Utilities
   **********************/
  function rand(a,b){ return Math.random()*(b-a)+a; }
  function randi(a,b){ return Math.floor(rand(a,b+1)); }
  function pick(arr){ return arr[randi(0, arr.length-1)]; }

  function resizeCanvas() {
    const rect = canvas.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener("resize", resizeCanvas);

  function flashWrong() {
    flash.classList.add("show");
    setTimeout(() => flash.classList.remove("show"), 120);
  }

  // One banner function for sequence + hint + rooster
  let bannerTimer = null;
  function showBanner(text, ms=1300) {
    banner.textContent = text;
    banner.classList.add("show");
    if (bannerTimer) clearTimeout(bannerTimer);
    bannerTimer = setTimeout(() => banner.classList.remove("show"), ms);
  }

  /**********************
   * Content
   **********************/
  // Text colors for noise (stable per token; no flicker)
  const NOISE_TEXT_COLORS = [
    "#FF2D55", "#FF3B30", "#FF6A00", "#FFCC00",
    "#34C759", "#00C7BE", "#0A84FF", "#5E5CE6",
    "#BF5AF2"
  ];

  // Vibrant bubble colors (stable; no flicker)
  const VIBRANT_BUBBLES = [
    "#FF2D55", "#FF3B30", "#FF6A00", "#FFCC00",
    "#34C759", "#00C7BE", "#0A84FF", "#5E5CE6",
    "#BF5AF2"
  ];

  const BW_BUBBLES = ["#0f1720", "#111827", "#1f2937"];

  // Recipes: simple cores, editable (kept intentionally non-absolute)
  const RECIPES = [
    { name: "Jollof (core)", steps: ["TOMATO","ONION","PEPPER","RICE"] },
    { name: "Egusi (core)",  steps: ["EGUSI","PALM OIL","SPINACH","STOCK"] },
    { name: "Suya (core)",   steps: ["PEANUT","CHILI","GINGER","ONION"] },
    { name: "Berbere Blend", steps: ["PAPRIKA","CUMIN","CLOVE","CHILI"] },
    { name: "Injera (core)", steps: ["TEFF","WATER","STARTER","TIME"] },
  ];

  // Token pool
  const TOKEN_POOL = [
    "TOMATO","ONION","PEPPER","RICE","EGUSI","PALM OIL","SPINACH","STOCK",
    "PEANUT","CHILI","GINGER","GARLIC","CUMIN","CLOVE","PAPRIKA","SALT",
    "OKRA","MILLET","TEFF","YAM","STARTER","TIME","BAY LEAF"
  ];

  // Near-match distractors (late-level load)
  const NEAR_MATCH_PACK = [
    "PIRI PIRI","PAPRIKA","PEPPER","CUBEB","CUMIN","CLOVE","TEFF","MILLET","BAY LEAF"
  ];

  // Marginalia unlocks:
  // - Levels 1‚Äì5: short ‚Äúnote‚Äù unlock
  // - Level 6: Auntie‚Äôs full 1998 note (your text)
  const AUNTIE_JOLLOF_NOTE =
`Three things they don't tell you:

‚Äî Tomato paste must fry until it darkens. That's the color.

‚Äî Onions go in twice. Once at the start, once at the end.

‚Äî The bay leaf? Take it out before serving. It's done its job.

The rest is between you and the pot.

‚Äî Auntie's margin, 1998`;

  const UNLOCKS = [
    { // level 1
      meta: "Cousin‚Äôs Margin (2006)",
      text:
`‚ÄúIf it smells good, you‚Äôre already winning.
But don‚Äôt stare at the pot.
Stare at the ORDER.‚Äù`
    },
    { // level 2
      meta: "Market Woman‚Äôs Margin (1993)",
      text:
`‚ÄúBuy onions like you mean it.
The sweet ones. The sharp ones.
Both belong.‚Äù`
    },
    { // level 3
      meta: "Uncle‚Äôs Margin (2001)",
      text:
`‚ÄúPepper has a family.
Some bite quick.
Some burn slow.
Don‚Äôt confuse them.‚Äù`
    },
    { // level 4
      meta: "Mom‚Äôs Margin (1999)",
      text:
`‚ÄúPalm oil is not just color.
It‚Äôs a signal.
Add it when the pot is listening.‚Äù`
    },
    { // level 5
      meta: "Grandma‚Äôs Margin (1982)",
      text:
`‚ÄúTaste is timing.
Not everything goes in at once.
The order is the recipe.‚Äù`
    },
    { // level 6 (final)
      meta: "Auntie‚Äôs Marginalia (1998)",
      text: AUNTIE_JOLLOF_NOTE
    },
  ];

  // Levels 1‚Äì6
  const LEVELS = [
    { level: 1, seconds: 35, speed: 1.00, bw: true,  colorNoise: false, steps: 3, tokens: 12, recipe: 0, hints: 2, nearMatches: false },
    { level: 2, seconds: 35, speed: 1.10, bw: true,  colorNoise: false, steps: 4, tokens: 14, recipe: 0, hints: 2, nearMatches: false },
    { level: 3, seconds: 32, speed: 1.20, bw: false, colorNoise: true,  steps: 4, tokens: 16, recipe: 1, hints: 2, nearMatches: false },
    { level: 4, seconds: 30, speed: 1.30, bw: false, colorNoise: true,  steps: 4, tokens: 18, recipe: 2, hints: 2, nearMatches: false },
    { level: 5, seconds: 28, speed: 1.40, bw: false, colorNoise: true,  steps: 5, tokens: 20, recipe: 3, hints: 2, nearMatches: true  },
    { level: 6, seconds: 26, speed: 1.55, bw: false, colorNoise: true,  steps: 5, tokens: 22, recipe: 4, hints: 2, nearMatches: true  },
  ];

  /**********************
   * Game Objects
   **********************/
  class Token {
    constructor(x,y,r,vx,vy,text,bubbleColor,textColor){
      this.x=x; this.y=y; this.r=r; this.vx=vx; this.vy=vy;
      this.text=text;
      this.bubbleColor=bubbleColor;
      this.textColor=textColor;
      this.alive=true;
      this.popping=false;
      this.popT=0;
    }
    hit(px,py){
      const dx=px-this.x, dy=py-this.y;
      return (dx*dx+dy*dy) <= this.r*this.r;
    }
    pop(){
      if(!this.alive||this.popping) return;
      this.popping=true; this.popT=0;
    }
    update(dt,w,h,speedMul){
      if(!this.alive) return;
      if(this.popping){
        this.popT += dt*3.2;
        if(this.popT>=1) this.alive=false;
        return;
      }
      this.x += this.vx*dt*speedMul;
      this.y += this.vy*dt*speedMul;

      const pad=2;
      if(this.x-this.r<pad){ this.x=this.r+pad; this.vx*=-1; }
      if(this.x+this.r>w-pad){ this.x=w-this.r-pad; this.vx*=-1; }
      if(this.y-this.r<pad){ this.y=this.r+pad; this.vy*=-1; }
      if(this.y+this.r>h-pad){ this.y=h-this.r-pad; this.vy*=-1; }
    }
    draw(ctx){
      if(!this.alive) return;

      let scale=1, alpha=1;
      if(this.popping){
        const t=Math.min(1,this.popT);
        scale=1-t*0.9;
        alpha=1-t;
      }

      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.translate(this.x,this.y);
      ctx.scale(scale,scale);

      // bubble
      ctx.beginPath();
      ctx.arc(0,0,this.r,0,Math.PI*2);
      ctx.fillStyle = this.bubbleColor;
      ctx.fill();
      ctx.lineWidth=2;
      ctx.strokeStyle="rgba(255,255,255,0.20)";
      ctx.stroke();

      // text (same font + sizing throughout)
      const size = Math.max(12, Math.min(16, this.r*0.32));
      ctx.textAlign="center";
      ctx.textBaseline="middle";
      ctx.fillStyle = this.textColor;
      ctx.font = `1000 ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      ctx.fillText(this.text, 0, 0);

      ctx.restore();
    }
  }

  /**********************
   * State
   **********************/
  let levelIndex = 0;
  let mode = "idle"; // showSeq|play|end
  let tokens = [];
  let lastTs = 0;

  let timeLeft = 0;
  let recipe = null;
  let seq = [];
  let seqIndex = 0;
  let hintsLeft = 0;

  // The unlock text that was just earned (for Copy Note)
  let lastUnlockedText = "";

  /**********************
   * Game Logic
   **********************/
  function setHUD(cfg){
    hudSubtitle.textContent = `Level ${cfg.level}: ${recipe.name}`;
    timeVal.textContent = `${Math.ceil(timeLeft)}s`;
    nextVal.textContent = seq[seqIndex] ?? "‚Äî";
    stepVal.textContent = `${seqIndex}/${seq.length}`;

    hintCountEl.textContent = String(hintsLeft);
    hintBtn.disabled = !(mode === "play" && hintsLeft > 0);
  }

  function buildSequence(cfg){
    recipe = RECIPES[cfg.recipe];
    seq = recipe.steps.slice(0, cfg.steps);
    seqIndex = 0;
    hintsLeft = cfg.hints ?? 2;
  }

  function spawnTokens(cfg){
    const rect = canvas.getBoundingClientRect();
    const w = rect.width, h = rect.height;

    const pool = cfg.nearMatches ? [...TOKEN_POOL, ...NEAR_MATCH_PACK] : [...TOKEN_POOL];

    // Ensure sequence items appear
    const set = new Set(seq);
    while(set.size < cfg.tokens){
      set.add(pick(pool));
    }
    const list = Array.from(set);

    // Expand: add extra copies of sequence tokens (feels rhythmic, not needle-hunting)
    const expanded = [];
    for(const s of seq){ expanded.push(s, s); }
    while(expanded.length < cfg.tokens){
      expanded.push(pick(list));
    }

    // shuffle
    for(let i=expanded.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [expanded[i],expanded[j]]=[expanded[j],expanded[i]];
    }

    const minR = Math.max(44, Math.min(58, w*0.12));
    const maxR = Math.max(56, Math.min(74, w*0.16));

    tokens = expanded.map(text=>{
      const r = rand(minR,maxR);
      const x = rand(r+6, w-r-6);
      const y = rand(r+6, h-r-6);

      const angle = rand(0,Math.PI*2);
      const baseSpeed = rand(28,42);
      const vx = Math.cos(angle)*baseSpeed;
      const vy = Math.sin(angle)*baseSpeed;

      const bubbleColor = cfg.bw ? pick(BW_BUBBLES) : pick(VIBRANT_BUBBLES);
      const textColor = cfg.bw
        ? "rgba(255,255,255,0.96)"
        : (cfg.colorNoise ? pick(NOISE_TEXT_COLORS) : "rgba(255,255,255,0.96)");

      return new Token(x,y,r,vx,vy,text,bubbleColor,textColor);
    });
  }

  function bringExpectedToFront() {
    const expected = seq[seqIndex] ?? "";
    tokens = [...tokens.filter(t => t.text !== expected), ...tokens.filter(t => t.text === expected)];
  }

  function beginLevel(){
    resizeCanvas();
    const cfg = LEVELS[levelIndex];

    buildSequence(cfg);
    timeLeft = cfg.seconds;

    spawnTokens(cfg);
    bringExpectedToFront();

    // clear overlays
    endOverlay.classList.remove("show");

    // hide unlock section while playing
    if (unlockBox) unlockBox.style.display = "none";
    lastUnlockedText = "";

    // show sequence briefly
    mode = "showSeq";
    showBanner(`RECIPE: ${seq.join(" ‚Üí ")}`, 1400);
    setTimeout(()=>{ mode = "play"; setHUD(cfg); }, 1400);

    setHUD(cfg);
    lastTs = performance.now();
    requestAnimationFrame(loop);

    startBtn.textContent = `Start Level ${cfg.level}`;
  }

  function showUnlockForLevel(lvlIdx) {
    const unlock = UNLOCKS[lvlIdx] || null;
    if (!unlock) {
      if (unlockBox) unlockBox.style.display = "none";
      return;
    }

    lastUnlockedText = `${unlock.meta}\n\n${unlock.text}`;

    unlockMeta.textContent = unlock.meta;
    unlockText.textContent = unlock.text;
    unlockBox.style.display = "block";
  }

  function endLevel(win){
    mode = "end";
    endOverlay.classList.add("show");

    // always reset unlock UI first
    if (unlockBox) unlockBox.style.display = "none";
    lastUnlockedText = "";

    const cfg = LEVELS[levelIndex];
    const isFinal = (levelIndex === LEVELS.length - 1);

    if (win) {
      if (isFinal) {
        endTitle.textContent = "üéâ CONGRATULATIONS!";
        endText.textContent = "You completed all 6 levels. Rhythm mastered.";

        // Big final unlock (Auntie‚Äôs full note)
        showUnlockForLevel(levelIndex);

        // no next level after final
        nextBtn.style.display = "none";
      } else {
        endTitle.textContent = "‚úÖ LEVEL CLEARED!";
        endText.textContent = `Level ${cfg.level} complete ‚Äî ${recipe.name}.`;

        // Unlock note for this level
        showUnlockForLevel(levelIndex);

        // allow next
        nextBtn.style.display = "inline-block";
      }
    } else {
      endTitle.textContent = "‚è≥ Time";
      endText.textContent = "Try again. (Hints cost 10 seconds.)";
      nextBtn.style.display = "none";
    }

    hintBtn.disabled = true;
  }

  function getPointerPos(ev){
    const rect = canvas.getBoundingClientRect();
    return { x: ev.clientX - rect.left, y: ev.clientY - rect.top };
  }

  function onPointerDown(ev){
    if(mode !== "play") return;
    const cfg = LEVELS[levelIndex];
    const {x,y} = getPointerPos(ev);

    let hit = null;
    for(let i=tokens.length-1;i>=0;i--){
      const t=tokens[i];
      if(t.alive && !t.popping && t.hit(x,y)){ hit=t; break; }
    }
    if(!hit) return;

    const expected = seq[seqIndex];

    if(hit.text === expected){
      hit.pop();
      seqIndex++;
      bringExpectedToFront();
      setHUD(cfg);

      if(seqIndex >= seq.length){
        setTimeout(()=>endLevel(true), 520);
      }
    } else {
      flashWrong();
      timeLeft = Math.max(0, timeLeft - 2);
      seqIndex = 0;
      bringExpectedToFront();
      setHUD(cfg);
    }
  }
  canvas.addEventListener("pointerdown", onPointerDown);

  // Hint: show sequence again + 10s penalty, max 2 per level
  hintBtn.addEventListener("click", () => {
    if(mode !== "play" || hintsLeft <= 0) return;
    const cfg = LEVELS[levelIndex];

    hintsLeft--;
    timeLeft = Math.max(0, timeLeft - 10);
    showBanner(`HINT: ${seq.join(" ‚Üí ")}`, 1400);
    setHUD(cfg);

    if(timeLeft <= 0) endLevel(false);
  });

  // Rooster distraction: harmless, cute
  rooster.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    if (mode === "play") showBanner("üêì COCK-A-DOODLE-DOO!", 700);
  });

  // Copy unlock note to clipboard
  copyUnlockBtn.addEventListener("click", async () => {
    if (!lastUnlockedText) return;
    try {
      await navigator.clipboard.writeText(lastUnlockedText);
      copyUnlockBtn.textContent = "Copied ‚úÖ";
      setTimeout(() => (copyUnlockBtn.textContent = "Copy Note"), 1200);
    } catch (e) {
      copyUnlockBtn.textContent = "Copy failed";
      setTimeout(() => (copyUnlockBtn.textContent = "Copy Note"), 1200);
    }
  });

  function loop(ts){
    const rect = canvas.getBoundingClientRect();
    const w = rect.width, h = rect.height;
    const dt = Math.min(0.033, (ts-lastTs)/1000);
    lastTs = ts;

    const cfg = LEVELS[levelIndex];

    if(mode === "showSeq" || mode === "play"){
      timeLeft -= dt;
      if(timeLeft < 0) timeLeft = 0;
      setHUD(cfg);

      if(timeLeft <= 0){
        endLevel(false);
        return;
      }

      for(const t of tokens) t.update(dt, w, h, cfg.speed);

      ctx.clearRect(0,0,w,h);
      ctx.fillStyle="#ffffff";
      ctx.fillRect(0,0,w,h);

      for(const t of tokens) t.draw(ctx);

      requestAnimationFrame(loop);
    }
  }

  /**********************
   * Buttons
   **********************/
  startBtn.addEventListener("click", ()=>{
    startOverlay.classList.remove("show");
    levelIndex = 0;
    beginLevel();
  });

  replayBtn.addEventListener("click", ()=>{
    beginLevel();
  });

  nextBtn.addEventListener("click", ()=>{
    if(levelIndex < LEVELS.length - 1) {
      levelIndex++;
      beginLevel();
    }
  });

  /**********************
   * Boot
   **********************/
  resizeCanvas();
})();
</script>
</body>
</html>
